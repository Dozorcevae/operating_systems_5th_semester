#!/usr/bin/env bash

TRASH_DIR="$HOME/.trash"
LOG_FILE="$HOME/.trash.log"

usage() { echo "Usage: $0 <filename_in_current_directory>"; }

if [ $# -ne 1 ]; then
  usage
  exit 1
fi

SRC_NAME="$1"

# файл должен существовать в текущем каталоге
if [ ! -e "$SRC_NAME" ]; then
  echo "Error: file '$SRC_NAME' not found in current directory."
  exit 1
fi

if [ ! -f "$SRC_NAME" ]; then
  echo "Error: '$SRC_NAME' is not a regular file."
  exit 1
fi

mkdir -p "$TRASH_DIR" 2>/dev/null || { echo "Error: cannot create $TRASH_DIR"; exit 1; }

ABS_PATH="$(realpath "$SRC_NAME" 2>/dev/null)"
if [ -z "$ABS_PATH" ]; then
  echo "Error: cannot resolve absolute path for '$SRC_NAME'."
  exit 1
fi

# следующий свободный ID
ID=1
while [ -e "$TRASH_DIR/$ID" ]; do
  ID=$((ID + 1))
done

# жёсткая ссылка в корзину
ln "$SRC_NAME" "$TRASH_DIR/$ID" 2>/dev/null || {
  echo "Error: cannot create hard link (ln)."
  exit 1
}

# удаляем оригинал
rm -f -- "$SRC_NAME" 2>/dev/null || {
  rm -f -- "$TRASH_DIR/$ID" 2>/dev/null
  echo "Error: cannot remove original file."
  exit 1
}

# лог: "ID - /abs/path"
echo "$ID - $ABS_PATH" >> "$LOG_FILE" 2>/dev/null || {
  echo "Warning: cannot write to log '$LOG_FILE'."
}

echo "OK: moved '$SRC_NAME' to trash with id=$ID"

